package com.lvhongbin.servlet;

import java.io.IOException;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import com.lvhongbin.bean.User;
import com.lvhongbin.service.ServiceSignInAndUpCheck;

/**
 * Servlet implementation class LoginCheckServlet
 * 
 */

public class SignInCheckServlet extends HttpServlet {
	private static final long serialVersionUID = 1L;
       
    /**
     * @see HttpServlet#HttpServlet()
     */
    public SignInCheckServlet() {
        super();
        // TODO Auto-generated constructor stub
    }

	/**
	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		
		if (null!=request.getParameter("btnQuitSignIn")) {
			response.sendRedirect("/Blog_jsp/jsp/Index.jsp?isQuitSignIn=true");
		}else {
			System.out.println("======== 调用了LoginCheckServlet的doGet（）方法");
			boolean fromPageSignUp=false;
			boolean signUpFlag=false;
			boolean signInFlag=false;
			boolean hasSignInName=false;
			User user=null;
			HttpSession session=request.getSession();
			if(null!=request.getAttribute("fromPage")){
	        	fromPageSignUp=(("SignUp".equals(request.getAttribute("fromPage").toString())))?true:false;
	        }
			if(fromPageSignUp) {
				user=(User)session.getAttribute("user");
				if(null!=session.getAttribute("signUpFlag")) {
					signUpFlag= (Boolean)session.getAttribute("signUpFlag");
					if(signUpFlag) {
						System.out.println("======== signInCheckServlet验证成功,通过注册的方式，注册成功 ========");
					}else {
						System.out.println("======== signInCheckServlet验证成功,通过注册的方式，注册失败 ========");
					}
				}
			}else {
				user=new User();
				String username = request.getParameter("user");
				String password = request.getParameter("pwd");
				user.setName(username);
				user.setPassword(password);
			}
			ServiceSignInAndUpCheck serviceSignInAndUpCheck =new ServiceSignInAndUpCheck(user);
			if(serviceSignInAndUpCheck.check()) {
				signInFlag=true;
				hasSignInName=true;				
				System.out.println("======== signInCheckServlet验证成功 ========");
			}else if(serviceSignInAndUpCheck.checkName()) {
				signInFlag=false;
				hasSignInName=true;
				System.out.println("======== signInCheckServlet验证失败,用户已存在! ========");
			}else {
				signInFlag=false;
				hasSignInName=false;
				System.out.println("======== signInCheckServlet验证失败，用户不存在! ========");
			}
			session.setAttribute("hasSignInName", hasSignInName);
			session.setAttribute("signInFlag", signInFlag);
			response.sendRedirect("/Blog_jsp/jsp/Index.jsp?fromPage=SignInCheckServlet");
		}
	}

	/**
	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
	 */
	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
		// TODO Auto-generated method stub
		doGet(request, response);
	}

}
